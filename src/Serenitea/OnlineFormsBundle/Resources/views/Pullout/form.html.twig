{% extends "CatalystTemplateBundle::base.html.twig"  %}
{% import "CatalystTemplateBundle::form.html.twig" as f %}

{% block content %}
{% if object.getStatus == 'Sent' %}
{% set readonly = true %}
{% endif %}
<div class="row">
<div class="col-md-12">
    <div class="portlet box blue-hoki">
        <div class="portlet-title">
            <div class="caption">Purchase Order {{ object.getCode }}</div>
        </div>
        <div class="portlet-body form">
            <form method="post" class="form-horizontal">
                <div class="form-body">
                    
<h4 class="form-section">Information</h4>
{{ f.group_text_readonly('Branch','warehouse',object.getWarehouse.getName,3,4) }}
{{ f.group_text('To','to',object.getTo,3,4, readonly) }}
{{ f.group_text('Cc','cc',object.getCc,3,4, readonly) }}
{{ f.group_select('Status','status',status_opts,object.getStatus,3,4, readonly) }}
<h4 class="form-section">Pull Out Requests</h4>
{% if not readonly %}
<button type="button" href="#en_form" id="add-item" class="btn btn-primary" data-toggle="modal" >Add Item</button>
{% endif %}
<div class="row table-responsive" style="padding-top:10px">
    <div class="col-md-12">
        <table id="en_table" class="table table-striped table-bordered table-hover" aria-describedby="list_table_info">
            <thead>
            <tr>
                    <th>Report Date</th>
                    <th>Item Description / Specifications</th>
                    <th>Quantity / Unit</th>
                    <th>U. Price</th>
                    <th>T. Price</th>
                    <th>Remarks</th>
                    <th></th>
            </tr>
            </thead>
        <tbody id="entries">
            {% for entry in object.getEntries %}
                <tr>
                    <td><input type="text" class="form-control date-picker" value="{{ entry.getReportDate|date('m/d/Y')}}" name="en_report_date[]" readonly /></td>
                    <td><input type="text" class="form-control"  value="{{ entry.getItem }}" name="en_item[]"  {{ readonly?'readonly':''}} /></td>
                    <td><input type="text" class="form-control price en_qty"  value="{{ entry.getQuantity }}" name="en_qty[]" {{ readonly?'readonly':''}} /></td>
                    <td><input type="text" class="form-control price en_price"  value="{{ entry.getPrice }}" name="en_price[]" {{ readonly?'readonly':''}} /></td>
                    <td><input type="text" class="form-control price en_total"  value="{{ entry.getTotalPrice }}" name="en_totalprice[]" readonly /></td>
                    <td><textarea class="form-control" name="en_remarks[]" {{ readonly?'readonly':''}} />{{ entry.getNotes }}</textarea></td>
                    <td>
                        {% if not readonly %}
                            <a href="javascript:void(0)" class="btn_en_del btn default btn-xs red-sunglo"><i class="fa fa-minus-circle"></i> Delete</a>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
            </table>
    </div>
</div>
    </div>
        
        <div class="form-actions fluid">
                <div class="col-md-9">
                    {% if not readonly %}
                    <button type="submit" class="btn blue">Save</button>
                    {% endif %}
                    <a href="#print_tag" class="btn green">Print</a>
                    <a href="{{ path('ser_pullout_index') }}" class="btn default">Cancel</a>
                </div>
            </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="en_form" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title">Pull Out Entry</h4>
            </div>
            <div class="modal-body">
                <div class="row form-horizontal form">
                    <div class="form-body">
                        {{ f.group_text('Report Date', 'report_date','', 3, 4,true) }}
                        {{ f.group_text('Item', 'item','', 3, 8) }}
                        {{ f.group_number('Quantity', 'qty','0.00', 3, 4) }}
                        {{ f.group_number('Price', 'price','0.00', 3, 4) }}
                        {{ f.group_textarea('Remarks', 'remarks','',3, 3, 8) }}
                        
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" data-dismiss="modal" class="btn default">Close</button>
                <button id="btn_en_submit" type="button" class="btn green">Add Entry</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block js %}
<script>
    
function update_totals() {
    var total_qty = 0.00;
    var total_price = 0.00;
    var total_total = 0.00;

    $('#en_table tr').each(function() {
        var qty = $(this).find('.en_qty').val();
        var price = $(this).find('.en_price').val();
        var total = qty * price;
        $(this).find('.en_total').val(total);

        total_qty += parseFloat(qty);
        total_price += parseFloat(price);
        total_total += parseFloat(total);
        
        $(this).find('.en_total').html(total.toFixed(2));
    });

    $('#total_total').html(total_total.toFixed(2));
}

function datepicker(){
    {% if not readonly %}
    $('.date-picker').each(function(){
        $(this).datepicker(); 
    });
    {% endif %}
}
$(document).ready(function() {
    $('#cform-report_date').datepicker();
    
    $('#en_table').on('click', '.btn_en_del', function() {
        $(this).closest('tr').remove();
        update_totals();
    });
    
    //Delete Row
    $('#en_table').on('change', '.en_qty, .en_price', function() {
    });
    // change values
    $('#en_table').on('change', '.en_qty, .en_price', function() {
        update_totals();
    });
    
    datepicker();
    
    $('#btn_en_submit').click(function(){
        var report_date = $('#cform-report_date').val();
        var item = $('#cform-item').val();
        var qty = $('#cform-qty').val();
        var price = $('#cform-price').val();
        var total = qty * price;
        var remarks = $('#cform-remarks').val();
        
        var row = '<tr>'+
                    '<td><input type="text" class="form-control date-picker" value="'+report_date+'" name="en_report_date[]" readonly /></td>'+
                    '<td><input type="text" class="form-control"  value="'+item+'" name="en_item[]"  /></td>'+
                    '<td><input type="text" class="form-control price en_qty"  value="'+qty+'" name="en_qty[]"  /></td>'+
                    '<td><input type="text" class="form-control price en_price"  value="'+price+'" name="en_price[]"  /></td>'+
                    '<td><input type="text" class="form-control price en_total"  value="'+total+'" name="en_totalprice[]" readonly /></td>'+
                    '<td><textarea class="form-control" name="en_remarks[]" >'+remarks+'</textarea></td>'+
                    '<td>'+
                        '<a href="javascript:void(0)" class="btn_en_del btn default btn-xs red-sunglo"><i class="fa fa-minus-circle"></i> Delete</a>'+
                    '</td></tr>';

        $('#en_table').append(row);
        $('#en_form').modal('hide');
        datepicker();
    });
});
</script>
{% endblock %}

